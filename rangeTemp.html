<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HistoriWeather – Daily High/Low</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- Header -->
  <header class="bg-blue-600 text-white py-6 shadow-md">
    <div class="max-w-6xl mx-auto px-6 flex flex-col sm:flex-row justify-between items-center">
      <h1 class="text-3xl font-bold">HistoriWeather</h1>
      <nav class="mt-3 sm:mt-0 space-x-4">
        <a href="/" class="hover:underline">Home</a>
        <a href="/hourly" class="hover:underline">Hourly (≤ 4 months)</a>
        <a href="/daily" class="hover:underline font-semibold underline">Daily High/Low</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="max-w-6xl mx-auto px-6 py-12">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
      <div>
        <h2 class="text-4xl font-bold mb-4">Daily High and Low Temperatures</h2>
        <p class="text-gray-700 mb-4">
          Explore long-term trends with daily minimum and maximum temperatures over large date ranges.
        </p>
        <p class="text-gray-600">
          Ideal for ranges longer than four months, or whenever you want a summarized daily view.
        </p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-xl font-semibold mb-4">Daily Range Search</h3>
        <ul class="list-disc list-inside text-gray-700 space-y-2">
          <li>Any range supported by the API (months to years).</li>
          <li>Daily 2m temperature min and max (°C).</li>
          <li>Two-line chart (high/low) + data table.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Input Section -->
  <section class="max-w-4xl mx-auto px-6 py-12 bg-white rounded-xl shadow-md -mt-10 relative z-10">
    <h3 class="text-2xl font-semibold text-center mb-6">Search Daily High/Low (Any Range)</h3>
    <form class="grid grid-cols-1 md:grid-cols-4 gap-6" onsubmit="return false;">
      <div>
        <label class="block font-semibold mb-1">Latitude</label>
        <input id="lat" type="number" step="any" placeholder="e.g. 43.7"
               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block font-semibold mb-1">Longitude</label>
        <input id="lon" type="number" step="any" placeholder="e.g. -79.4"
               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block font-semibold mb-1">Start Date</label>
        <input id="startDate" type="date"
               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div>
        <label class="block font-semibold mb-1">End Date</label>
        <input id="endDate" type="date"
               class="w-full border rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-400">
      </div>
      <div class="md:col-span-4 flex justify-center">
        <button id="fetchBtn" type="button"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-semibold">
          Fetch Daily High/Low
        </button>
      </div>
    </form>
  </section>

  <!-- Results Section -->
  <section class="max-w-5xl mx-auto px-6 py-12 text-center">
    <h3 class="text-2xl font-semibold mb-4">Results</h3>
    <p class="text-gray-600" id="resultsMessage">Your data will appear here once retrieved.</p>

    <div class="mt-8 h-[400px]">
      <h4 class="text-xl font-semibold mb-3">Daily High/Low Chart</h4>
      <canvas id="tempChart" class="w-full h-full"></canvas>
    </div>

    <div id="resultsContainer"
         class="mt-6 min-h-[16rem] border-2 border-dashed border-gray-300 rounded-lg p-4 overflow-x-auto">
      <!-- Table injected here -->
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-300 py-8 mt-12">
    <div class="max-w-6xl mx-auto px-6 flex flex-col sm:flex-row justify-between items-center">
      <p>© 2025 HistoriWeather. All rights reserved.</p>
      <div class="space-x-4 mt-3 sm:mt-0">
        <a href="#" class="hover:text-white">Privacy</a>
        <a href="#" class="hover:text-white">Terms</a>
        <a href="#" class="hover:text-white">Contact</a>
      </div>
    </div>
  </footer>

  <!-- JS Logic -->
  <script>
    const fetchBtn = document.getElementById("fetchBtn");
    const latInput = document.getElementById("lat");
    const lonInput = document.getElementById("lon");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const resultsMessage = document.getElementById("resultsMessage");
    const resultsContainer = document.getElementById("resultsContainer");
    const tempChartCanvas = document.getElementById("tempChart");

    let tempChart = null;

    fetchBtn.addEventListener("click", async () => {
      const lat = latInput.value.trim();
      const lon = lonInput.value.trim();
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;

      if (!lat || !lon || !startDate || !endDate) {
        setMessage("Please enter latitude, longitude, start date, and end date.", "error");
        clearOutput();
        return;
      }

      const start = new Date(startDate);
      const end = new Date(endDate);

      if (isNaN(start.getTime()) || isNaN(end.getTime())) {
        setMessage("Invalid date(s) selected.", "error");
        clearOutput();
        return;
      }

      if (end < start) {
        setMessage("End date must be on or after the start date.", "error");
        clearOutput();
        return;
      }

      const msPerDay = 24 * 60 * 60 * 1000;
      const spanDays = Math.round((end - start) / msPerDay) + 1;

      setMessage(`Fetching daily high/low for ${spanDays} day(s)...`, "neutral");
      clearOutput();

      try {
        const resp = await fetch(
          `/api/daily?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`
        );

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error || `Request failed with status ${resp.status}`);
        }

        const data = await resp.json();
        const times = data.time || [];
        const tMin = data.temperature_2m_min || [];
        const tMax = data.temperature_2m_max || [];

        if (!times.length || !tMin.length || !tMax.length) {
          setMessage("No daily data returned for that date range/location.", "error");
          clearOutput();
          return;
        }

        renderDaily(times, tMin, tMax, startDate, endDate, spanDays);

      } catch (err) {
        console.error(err);
        setMessage("Error fetching data: " + err.message, "error");
        clearOutput();
      }
    });

    function setMessage(text, type) {
      resultsMessage.textContent = text;
      resultsMessage.classList.remove("text-gray-600", "text-green-600", "text-red-600");

      if (type === "success") {
        resultsMessage.classList.add("text-green-600");
      } else if (type === "error") {
        resultsMessage.classList.add("text-red-600");
      } else {
        resultsMessage.classList.add("text-gray-600");
      }
    }

    function clearOutput() {
      resultsContainer.innerHTML = "";
      if (tempChart) {
        tempChart.destroy();
        tempChart = null;
      }
    }

    function renderDaily(times, tMin, tMax, startDate, endDate, spanDays) {
      setMessage(
        `Showing DAILY min/max temperatures from ${startDate} to ${endDate} (${spanDays} day(s)).`,
        "success"
      );

      let tableHtml = `
        <table class="min-w-full text-left text-sm">
          <thead>
            <tr class="border-b">
              <th class="py-2 px-3 font-semibold">Date</th>
              <th class="py-2 px-3 font-semibold">Min (°C)</th>
              <th class="py-2 px-3 font-semibold">Max (°C)</th>
            </tr>
          </thead>
          <tbody>
      `;

      const labels = [];
      const valsMin = [];
      const valsMax = [];

      for (let i = 0; i < times.length; i++) {
        const dateStr = times[i];
        const vMin = tMin[i];
        const vMax = tMax[i];

        labels.push(dateStr);
        valsMin.push(vMin);
        valsMax.push(vMax);

        tableHtml += `
          <tr class="border-b last:border-0">
            <td class="py-2 px-3">${dateStr}</td>
            <td class="py-2 px-3">${Number(vMin).toFixed(1)}</td>
            <td class="py-2 px-3">${Number(vMax).toFixed(1)}</td>
          </tr>
        `;
      }

      tableHtml += "</tbody></table>";
      resultsContainer.innerHTML = tableHtml;

      const ctx = tempChartCanvas.getContext("2d");
      if (tempChart) tempChart.destroy();
      tempChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Max (°C)",
              data: valsMax,
              fill: false,
              tension: 0.3
            },
            {
              label: "Min (°C)",
              data: valsMin,
              fill: false,
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              title: { display: true, text: "Date" },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 12
              }
            },
            y: {
              title: { display: true, text: "Temperature (°C)" }
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ": " +
                         context.parsed.y.toFixed(1) + " °C";
                }
              }
            }
          }
        }
      });
    }
  </script>

</body>
</html>
